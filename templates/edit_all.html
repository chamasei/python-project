<link href="../static/style.css" rel = "stylesheet" />
<body>

    <header id = "edit_all_header">
        <div>
            <label for="jumpTo">å•é¡Œç•ªå·ã¸ç§»å‹•:</label>
            <input type="number" id="jumpTo" min="1" max="400">
            <button id="jumpButton">ç§»å‹•</button>
        </div>
    </header>

        <div class="container">
            <main id = "edit_main">
                <h2>ç™»éŒ²æ¸ˆã¿ã®å•é¡Œä¸€è¦§</h2>

                {% for question in questions %}
                <div class="edit-question-container" id="container_{{ question.id }}" style="display: none;">
                    <div class =edit-question-container_css>
                        <div class="edit-tools">
                            <p>ID: {{ question.id }}</p>
                            <button class ="edit-button" onclick="saveQuestion({{ question.id }})">ä¿å­˜</button>
                            <button class ="delete-button" onclick="deleteQuestion({{ question.id }})">å‰Šé™¤</button>
                        </div>
                        <div class ="edit-container">
                            <textarea class ="question-box" id="edit_question_{{ question.id }}">{{ question.question }}</textarea>
                            <textarea class ="answer-box" id="edit_answer_{{ question.id }}">{{ question.answer }}</textarea>
                            <textarea class = "description-box" id="edit_description_{{ question.id }}">{{ question.description }}</textarea>
                        </div>
                    </div>    
                
                    <div id = "select_box">
                        <label class="label_select" for="difficulty_level_id">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ:</label>
                            <select name="category_id" id ="edit_category_menu">
                                <option value="{{ question[4] }}" selected>{{ question[5] }}</option>
                                    {% for category in categories %}
                                        {% if category.id != question[4] %}  <!-- âœ… æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¯é™¤å¤– -->
                                            <option value="{{ category.id }}">{{ category.name }}</option>
                                        {% endif %} 
                                    {% endfor %}                   .
                            </select>
                    
                            <label class="label_select" for="difficulty_level_id">é›£æ˜“åº¦ã‚’é¸æŠ:</label>
                            <select name="difficulty_level_id" id = "edit_difficulty_level_menu">
                                <option value="{{ question[6] }}" selected>{{ question[7] }}</option>  <!-- âœ… ç¾åœ¨ã®é›£æ˜“åº¦ã‚’é¸æŠæ¸ˆã¿ã«ã™ã‚‹ -->
                                    {% for level in difficulty_levels %}
                                        {% if level.id != question[6]%} 
                                        <option value="{{ level.id}}">{{ level.level }}</option>
                                        {% endif %} 
                                    {% endfor %}
                            </select>
                        </div>
                    </div>
                {% endfor %}

                <button id="loadMore">æ¬¡ã®10å•</button>
            </main>
        </div>

<script>
    function deleteQuestion(id) {
        if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            fetch(`/delete/${id}`, {
                method: 'POST',
            })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url; // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                }
            })
            .catch(error => {
                alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                console.error(error);
            });
        }
    }


    function saveQuestion(id) {
        const question = document.getElementById(`edit_question_${id}`).value;
        const answer = document.getElementById(`edit_answer_${id}`).value;
        const description = document.getElementById(`edit_description_${id}`).value;
        const category_id = document.querySelector('[name="category_id"]').value;
        const difficulty_level_id = document.querySelector('[name="difficulty_level_id"]').value;

        fetch(`/admin/edit/${id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question: question,
                answer: answer,
                description: description,
                category_id: category_id,
                difficulty_level_id: difficulty_level_id,
            }),
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);  // âœ… ã€Œæ›´æ–°æˆåŠŸã€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

        // âœ… ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã›ãšã«ã€HTML ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ï¼
        document.getElementById(`edit_question_${id}`).textContent = question;
        document.getElementById(`edit_answer_${id}`).textContent = answer;
        document.getElementById(`edit_description_${id}`).textContent = description;

        // âœ… æ›´æ–°æˆåŠŸã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆãªã©ï¼‰
        let container = document.getElementById(`container_${id}`);
        container.style.backgroundColor = "lightgreen";
        setTimeout(() => container.style.backgroundColor = "", 2000);
    })
    .catch(error => {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
    });

    }
 
    function editQuestion(id) {
        // ç·¨é›†ãƒšãƒ¼ã‚¸ã«ç§»å‹•
        window.location.href = `/admin/edit/${id}`;
    } 

//ã€Œæ¬¡ã®10å•ã€ã‚’è¡¨ç¤º
    let visibleCount = 0;

    function showMoreQuestions() {
        let questions = document.querySelectorAll(".edit-question-container");
        for (let i = visibleCount; i < visibleCount + 10 && i < questions.length; i++) {
            questions[i].style.display = "block";  // âœ… 10å•ãšã¤è¡¨ç¤º
        }
        visibleCount += 10;

        // âœ… ã™ã¹ã¦ã®å•é¡ŒãŒè¡¨ç¤ºã•ã‚ŒãŸã‚‰ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        if (visibleCount >= questions.length) {
            document.getElementById("loadMore").style.display = "none";
        }
    }

    // âœ… ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æœ€åˆã®10å•ã‚’è¡¨ç¤º
    document.addEventListener("DOMContentLoaded", function () {
        showMoreQuestions();
    });



    // âœ… æ¬¡ã®10å•ã‚’è¡¨ç¤º
    document.getElementById("loadMore").addEventListener("click", showMoreQuestions);

//ï¼ˆã‚¸ãƒ£ãƒ³ãƒ—ï¼‹è©²å½“ã®10å•ã‚’é–‹ãï¼‰
    document.getElementById("jumpButton").addEventListener("click", function () {

        let targetId = document.getElementById("jumpTo").value;


        let questions = document.querySelectorAll(".edit-question-container");
        let targetElement = document.getElementById("container_" + targetId);
        //console.log("ğŸ” JavaScript ã§å–å¾—ã—ãŸ targetElement:", targetElement);

        if (targetElement) {
            //console.log("âœ… å–å¾—ã—ãŸå•é¡Œ ID:", targetElement.id);

            // **ã‚¸ãƒ£ãƒ³ãƒ—å…ˆã®å•é¡Œã®ä½ç½®ã‚’ç‰¹å®š**
            let targetIndex = Array.from(questions).findIndex(q => q.id === "container_" + targetId);

            // **ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¾ã§ `showMoreQuestions()` ã‚’å®Ÿè¡Œ**
            while (visibleCount < targetIndex + 1) {
                showMoreQuestions();
            }

            // **è¡¨ç¤ºã‚’ç¢ºå®Ÿã«ã™ã‚‹**
            targetElement.style.display = "block";

            // **ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†**
            targetElement.scrollIntoView({ behavior: "smooth" });

            // **ãƒã‚¤ãƒ©ã‚¤ãƒˆ**
            targetElement.style.backgroundColor = "yellow";
            setTimeout(() => targetElement.style.backgroundColor = "", 2000);
        } else {
            console.log("âŒ è©²å½“ã™ã‚‹å•é¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼");
        }
    });

// âœ… Enterã‚­ãƒ¼ã§ã‚‚å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼
    document.getElementById("jumpTo").addEventListener("keydown", function (event) {
        if (event.key === "Enter") {
            document.getElementById("jumpButton").click();
        }
    });


</script>
</body>