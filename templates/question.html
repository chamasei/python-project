{% extends "base.html" %}
{% block content %}

        <main >
            <!-- 🔹 ここにフラッシュメッセージを追加 -->
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <p class="flash {{ category }}">{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
            {% endwith %}

            <!-- ナビゲーションボタン -->
            <div class="navigation-buttons"id="question-start">
                {% if prev_index is not none %}
                <a href="{{ url_for('view_question', id=prev_id, category_id=category_id, difficulty_level_id=difficulty_level_id, q=query) }}" 
                class="prev-button" onclick="showMessage(event, '🚀 前の問題はありません。最後の問題に戻ります。')">
                <i class="fa-solid fa-circle-arrow-left"></i></a>
                {% else %}
                    <span class="disabled-button">前の問題</span>
                {% endif %}

                <div  id ="question_number"><p>{{ question_number }}/{{ total_questions }}</p></div>
                      
                {% if next_index is not none %}
                <a href="{{ url_for('view_question', id=next_id, category_id=category_id, difficulty_level_id=difficulty_level_id,q=query) }}" 
                class="next-button" onclick="showMessage(event, '🚀 次の問題はありません。最初の問題に戻ります。')">
                <i class="fa-solid fa-circle-arrow-right"></i></a>

                {% else %}
                    <span class="disabled-button">次の問題</span>
                {% endif %}

            </div>
                <!-- ✅ 1つのメッセージエリアだけを作る！ -->
                <p id="message-box" class="hidden-message"></p>


            <!-- 問題表示 -->
            {% if question %}
                <div class="question-container" >
                    <div id = "question_info">
                        <p class ="question_info">ID:{{ question.id}}</p>
                        <p class ="question_info">カテゴリ:{{ question.category_name}}</p>
                    </div>
                    <div class="question-box">
                        <p class="contents_text">問題: {{ question.question | safe }}</p>
                    </div>


        
                    <!-- コード実行エリア -->
                    <strong>コードを書いて試してみよう:</strong>
                    <div id = "code_input_area">
                        <textarea id="code-editor"></textarea>
                        <button id = "code_enter_button"onclick="runPythonCode()">実行</button>
                    </div> 
                    
                    <pre id="output"></pre> <!-- 出力を表示するエリア -->
            
                        <!-- 解答ボタン -->
                    <button id="answer-button" onclick="showAnswerAndDescription('answer{{ question.id }}', 'description{{ question.id }}')">
                        解答を見る
                    </button>
                                
                    <!-- 解答 -->
                    <div id="answer{{ question['id'] }}" class="answer-box" style="display: none;">
                        <p class="contents_text">解答: {{ question.answer | safe }}</p>
                    </div>
                    
                    <div id="description{{ question['id'] }}" class="description-box" style="display: none;">
                        <p class="contents_text">解説: {{ question.description | safe }}</p>
                    </div>
                </div>
            {% else %}
                <p>該当する問題がありません。</p>
            {% endif %}
                

        

            <!-- ナビゲーションボタン -->
            <div class="navigation-buttons"id="question-start">
                {% if prev_index is not none %}
                <a href="{{ url_for('view_question', id=prev_id, category_id=category_id, difficulty_level_id=difficulty_level_id, q=query) }}" 
                class="prev-button" onclick="showMessage(event, '🚀 前の問題はありません。最後の問題に戻ります。')">
                <i class="fa-solid fa-circle-arrow-left"></i></a>
                {% else %}
                    <span class="disabled-button">前の問題</span>
                {% endif %}

                <div  id ="question_number"><p>{{ question_number }}/{{ total_questions }}</p></div>
                      
                {% if next_index is not none %}
                <a href="{{ url_for('view_question', id=next_id, category_id=category_id, difficulty_level_id=difficulty_level_id,q=query) }}" 
                class="next-button" onclick="showMessage(event, '🚀 次の問題はありません。最初の問題に戻ります。')">
                <i class="fa-solid fa-circle-arrow-right"></i></a>

                {% else %}
                    <span class="disabled-button">次の問題</span>
                {% endif %}



            </div>

        </main>

                
        
    </div>





<script>
function showAnswerAndDescription(answerId, descriptionId) {
    // 解答を表示
    document.getElementById(answerId).style.display = "block";
    // 解説を表示
    document.getElementById(descriptionId).style.display = "block";
}

<!-- コード入力用スクリプト -->


<!-- CodeMirror を適用するスクリプト -->
    // CodeMirror を適用
    var editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
        mode: "python",
        theme: "dracula",
        lineNumbers: true,
        indentUnit: 4,
        tabSize: 4,
        smartIndent: true,
        matchBrackets: true
    });

    function runPythonCode() {
        var code = editor.getValue(); // CodeMirror の内容を取得
        fetch('/run', {  // Flask のエンドポイント "/run" にコードを送信
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ code: code })  // JSON でコードを送る
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById("output").textContent = data.result; // 結果を表示
        })
        .catch(error => {
            console.error("エラー:", error);
            document.getElementById("output").textContent = "実行エラー";
        });
    }

    function handleCategorySubmit() {
        const form = document.querySelector("form");
        form.submit();
        return false; // ✅ 二重送信を防ぐ！
    }
    


    // ✅ URL から `q=` を削除する関数
    window.onload = function() {
        let url = new URL(window.location);
        if (url.searchParams.has("q") && url.searchParams.get("q") === "") {
            url.searchParams.delete("q");
            window.history.replaceState(null, "", url.toString());
        }
    };

  

    document.addEventListener("DOMContentLoaded", function() {
    const targetElement = document.getElementById("question-start");

    if (targetElement) {
        let offset = window.innerWidth <= 768 ? 0 : 500;  // ✅ スマホとPCでオフセット変更
        let targetPosition = targetElement.getBoundingClientRect().top + window.scrollY - offset;

        console.log(`📍 スクロール位置: ${targetPosition} (オフセット: ${offset})`);

        window.scrollTo({
            top: targetPosition,
            behavior: "smooth"
        });
    }
});


    function showMessage(event, text) {
        event.preventDefault();  // ✅ ボタンのデフォルト動作を防ぐ

        const messageElement = document.getElementById("message-box");

        messageElement.textContent = text;
        messageElement.style.display = "block"; // ✅ メッセージを表示
        setTimeout(() => {
            window.location.href = event.target.href;  // ✅ 1.5秒後にページ遷移
        }, 1500);
    }



</script>


{% endblock %}

